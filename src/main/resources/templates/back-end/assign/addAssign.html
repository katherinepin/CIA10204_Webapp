<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>每月排班編輯工具</title>
    <link rel="stylesheet" href="/css/assign.css">
</head>
<body>
    <div class="container">
        <h1>每月排班編輯工具</h1>
        
        <div class="month-selector">
            <select id="yearSelect"></select>
            <select id="monthSelect"></select>
        </div>
        <form id="assignForm" th:action="@{/assign/insert}" method="post">
            <div id="calendar"></div>
            <button type="submit">保存排班</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/assign/api/employees')
                .then(response => response.json())
                .then(data => {
                    console.log("Received data:", data);
                    initializeCalendar(data);
                })
                .catch(error => console.error('Error loading the employees:', error));

            function initializeCalendar(data) {
                const calendar = document.getElementById('calendar');
                const form = document.getElementById('assignForm');
                const yearSelect = document.getElementById('yearSelect');
                const monthSelect = document.getElementById('monthSelect');

                // 初始化年份選擇
                const currentYear = new Date().getFullYear();
                for (let year = currentYear - 1; year <= currentYear + 1; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                }
                yearSelect.value = currentYear;

                // 初始化月份選擇
                for (let month = 1; month <= 12; month++) {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month + '月';
                    monthSelect.appendChild(option);
                }
                monthSelect.value = new Date().getMonth() + 1;

                // 創建日曆
                function createCalendar(year, month) {
                    calendar.innerHTML = ''; // 清空現有日曆
                    const daysInMonth = new Date(year, month, 0).getDate();
                    const firstDay = new Date(year, month - 1, 1).getDay();
                    const dayNames = ['日', '一', '二', '三', '四', '五', '六'];

                    // 添加星期幾的標題
                    dayNames.forEach(day => {
                        const dayHeader = document.createElement('div');
                        dayHeader.className = 'day day-header';
                        dayHeader.textContent = day;
                        calendar.appendChild(dayHeader);
                    });

                    // 添加空白日期
                    for (let i = 0; i < firstDay; i++) {
                        const emptyDay = document.createElement('div');
                        emptyDay.className = 'day empty';
                        calendar.appendChild(emptyDay);
                    }

                    // 添加每一天的單元格
                    for (let i = 1; i <= daysInMonth; i++) {
                        const dayCell = document.createElement('div');
                        dayCell.className = 'day';
                        dayCell.innerHTML = `
                        <select name="employees[]" required>
                            <option value="">選擇員工</option>
                            ${data.employees.map(emp => `<option value="${emp.empId}">${emp.empName}</option>`).join('')}
                        </select>
                        <input type="hidden" name="dates[]" value="${year}-${month.toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}">
                        `;
                        calendar.appendChild(dayCell);
                    }
                }

                // 初始創建日曆
                createCalendar(currentYear, new Date().getMonth() + 1);

                // 當年份或月份改變時重新創建日曆
                yearSelect.addEventListener('change', updateCalendar);
                monthSelect.addEventListener('change', updateCalendar);

                function updateCalendar() {
                    const selectedYear = parseInt(yearSelect.value);
                    const selectedMonth = parseInt(monthSelect.value);
                    createCalendar(selectedYear, selectedMonth);
                }

                // 表單提交
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(form);
                    fetch(form.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())  // 確保解析返回的JSON
                    .then(data => {
                        if (data.message) {
                            alert(data.message);
                        }
                        if (data.error) {
                            alert(data.error);
                        }
                        // 可以在這裡添加更多的成功後或錯誤處理的操作
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('保存失敗，請重試');
                    });
                });
            }
        });
    </script>
</body>
</html>
